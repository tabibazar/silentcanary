name: Update Environment Variables

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  update-env:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Add EC2 to known hosts
      run: |
        ssh-keyscan -H 35.182.6.75 >> ~/.ssh/known_hosts

    - name: Update SendGrid API Key
      run: |
        echo "ğŸ”‘ Updating SendGrid API key on EC2..."
        ssh -i ~/.ssh/id_rsa ubuntu@35.182.6.75 'cd /opt/silentcanary && \
          echo "ğŸ“ Backing up current .env file..." && \
          cp .env .env.backup.$(date +%Y%m%d_%H%M%S) && \
          echo "" && \
          echo "ğŸ”§ Updating SENDGRID_API_KEY..." && \
          sed -i "s/^SENDGRID_API_KEY=.*/SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}/" .env && \
          echo "" && \
          echo "ğŸ”§ Updating MAIL_DEFAULT_SENDER..." && \
          sed -i "s/^MAIL_DEFAULT_SENDER=.*/MAIL_DEFAULT_SENDER=no-reply@silentcanary.com/" .env && \
          echo "" && \
          echo "âœ… Environment variables updated" && \
          echo "" && \
          echo "ğŸ”„ Restarting services to apply changes..." && \
          docker-compose restart && \
          echo "" && \
          echo "â³ Waiting 15 seconds for services to start..." && \
          sleep 15 && \
          echo "" && \
          echo "ğŸ“Š Checking service status..." && \
          docker-compose ps && \
          echo "" && \
          echo "âœ… Update complete!"'
