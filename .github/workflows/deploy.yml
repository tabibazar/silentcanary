name: Deploy SilentCanary to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  EC2_HOST: 35.182.6.75
  EC2_USER: ubuntu
  APP_DIR: /opt/silentcanary

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Add EC2 to known hosts
      run: |
        ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        # Create deployment script
        cat > deploy_script.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "üöÄ Starting deployment..."

        # Check if app directory exists, if not create it and clone
        if [ ! -d "${{ env.APP_DIR }}" ]; then
          echo "üìÅ Creating app directory and cloning repository..."
          sudo mkdir -p ${{ env.APP_DIR }}
          sudo chown ubuntu:ubuntu ${{ env.APP_DIR }}
          git clone https://github.com/tabibazar/silentcanary.git ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}

          # Run initial setup
          echo "üîß Running initial setup..."
          if [ -f "complete-deployment.sh" ]; then
            chmod +x complete-deployment.sh
            ./complete-deployment.sh
          fi
        else
          # Navigate to app directory
          cd ${{ env.APP_DIR }}

          # Pull latest changes
          echo "üì• Pulling latest code..."
          git reset --hard HEAD
          git clean -fd
          git pull origin main
        fi

        # Create .env file if it doesn't exist
        if [ ! -f ".env" ]; then
          echo "Creating .env file..."
          if [ -f ".env.template" ]; then
            cp .env.template .env
          else
            echo "Creating basic .env file..."
            echo "FLASK_ENV=production" > .env
            echo "FLASK_APP=app.py" >> .env
            echo "SECRET_KEY=temp_secret_key_change_this" >> .env
            echo "AWS_ACCESS_KEY_ID=your_aws_access_key" >> .env
            echo "AWS_SECRET_ACCESS_KEY=your_aws_secret_key" >> .env
            echo "AWS_DEFAULT_REGION=ca-central-1" >> .env
            echo "STRIPE_WEBHOOK_SECRET=whsec_RcURWsWzfABXKmQiEmpwMJCUabKvrEZh" >> .env
            echo "SENDGRID_API_KEY=SG.your_sendgrid_key" >> .env
            echo "FROM_EMAIL=noreply@silentcanary.com" >> .env
            echo "REDIS_URL=redis://redis:6379/0" >> .env
            echo "REDIS_HOST=redis" >> .env
            echo "REDIS_ENDPOINT=" >> .env
            echo "BASE_URL=https://silentcanary.com" >> .env
          fi
        fi

        # Update environment variables
        echo "‚öôÔ∏è Updating environment..."

        # Update AWS credentials if provided via environment
        if [ ! -z "$AWS_ACCESS_KEY_ID" ] && [ ! -z "$AWS_SECRET_ACCESS_KEY" ]; then
          echo "üîë Updating AWS credentials..."
          sed -i "s/AWS_ACCESS_KEY_ID=.*/AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID/" .env
          sed -i "s/AWS_SECRET_ACCESS_KEY=.*/AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY/" .env
        fi

        # Ensure Redis uses Docker network
        if ! grep -q "REDIS_HOST=redis" .env; then
          echo "REDIS_HOST=redis" >> .env
        fi
        if ! grep -q "REDIS_ENDPOINT=" .env; then
          echo "REDIS_ENDPOINT=" >> .env
        fi

        # Ensure Docker and Docker Compose are installed
        if ! command -v docker &> /dev/null; then
          echo "üê≥ Installing Docker..."
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker ubuntu
        fi

        if ! command -v docker-compose &> /dev/null; then
          echo "üê≥ Installing Docker Compose..."
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
        fi

        # Fix port conflicts
        echo "üîß Fixing port conflicts..."
        sudo systemctl stop nginx 2>/dev/null || echo "System nginx not running"
        sudo systemctl disable nginx 2>/dev/null || echo "System nginx not enabled"
        sudo systemctl stop apache2 2>/dev/null || echo "Apache not running"
        sudo systemctl disable apache2 2>/dev/null || echo "Apache not enabled"

        # Kill any processes using port 80
        sudo fuser -k 80/tcp 2>/dev/null || echo "No processes on port 80"
        sudo fuser -k 443/tcp 2>/dev/null || echo "No processes on port 443"

        # Stop current containers if they exist
        echo "üõë Stopping current containers..."
        docker-compose down 2>/dev/null || echo "No containers to stop"

        # Clean up old images
        echo "üßπ Cleaning up..."
        docker system prune -f

        # Build and start new containers
        echo "üî® Building and starting containers..."
        docker-compose up -d --build

        # Wait for services to start
        echo "‚è≥ Waiting for services..."
        sleep 30

        # Setup SSL certificates with Let's Encrypt
        echo "üîí Setting up SSL certificates..."
        if [ ! -f "/etc/letsencrypt/live/silentcanary.com/fullchain.pem" ]; then
          echo "üìú Obtaining SSL certificate from Let's Encrypt..."

          # Install certbot if not present
          if ! command -v certbot &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y certbot
          fi

          # Stop nginx container temporarily for certificate generation
          docker-compose stop nginx

          # Generate certificate using standalone mode
          # Try with both domains first, fallback to main domain only
          if ! sudo certbot certonly --standalone \
            --preferred-challenges http \
            --email admin@silentcanary.com \
            --agree-tos \
            --no-eff-email \
            --force-renewal \
            -d silentcanary.com \
            -d www.silentcanary.com; then

            echo "‚ö†Ô∏è Failed with both domains, trying main domain only..."
            sudo certbot certonly --standalone \
              --preferred-challenges http \
              --email admin@silentcanary.com \
              --agree-tos \
              --no-eff-email \
              --force-renewal \
              -d silentcanary.com
          fi

          # Copy certificates to accessible location
          sudo mkdir -p /opt/silentcanary/ssl
          sudo cp /etc/letsencrypt/live/silentcanary.com/fullchain.pem /opt/silentcanary/ssl/silentcanary.com.crt
          sudo cp /etc/letsencrypt/live/silentcanary.com/privkey.pem /opt/silentcanary/ssl/silentcanary.com.key
          sudo chown -R ubuntu:ubuntu /opt/silentcanary/ssl

          # Update nginx config to use SSL
          if [ -f "nginx-ssl.conf" ]; then
            cp nginx-ssl.conf nginx.conf
          fi

          # Restart containers with SSL
          docker-compose up -d
        else
          echo "‚úÖ SSL certificates already exist"
        fi

        # Set up automatic SSL renewal
        echo "üîÑ Setting up SSL certificate auto-renewal..."
        if ! crontab -l | grep -q "renew-ssl.sh"; then
          # Add cron job for certificate renewal (runs daily at 2 AM)
          (crontab -l 2>/dev/null; echo "0 2 * * * /opt/silentcanary/renew-ssl.sh >> /opt/silentcanary/logs/ssl-renewal.log 2>&1") | crontab -
          echo "‚úÖ SSL auto-renewal cron job added"
        else
          echo "‚úÖ SSL auto-renewal already configured"
        fi

        # Health check
        echo "üîç Running health check..."
        if curl -f http://localhost/health; then
          echo "‚úÖ Deployment successful!"
        else
          echo "‚ùå Health check failed"
          docker-compose logs
          exit 1
        fi
        EOF

        # Execute deployment script on EC2
        ssh -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}' AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}' bash -s" < deploy_script.sh

    - name: Verify deployment
      run: |
        # Wait a bit more for full startup
        sleep 10

        # Test external access
        if curl -f http://${{ env.EC2_HOST }}/health; then
          echo "‚úÖ External health check passed!"
        else
          echo "‚ùå External health check failed"
          exit 1
        fi

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ Deployment completed successfully!"
          echo "üåê Application available at: http://silentcanary.com"
        else
          echo "‚ùå Deployment failed!"
        fi