{% extends "base.html" %}

{% block title %}Smart Alerts - {{ canary.name }} - SilentCanary{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-brain text-primary"></i> Smart Alerts: {{ canary.name }}
            </h1>
            <div>
                <a href="{{ url_for('canary_analytics', canary_id=canary.canary_id) }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-chart-line"></i> Analytics
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Smart Alert Status Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot"></i> Smart Alert Status
                </h5>
            </div>
            <div class="card-body">
                {% if smart_alert and smart_alert.is_enabled %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Smart alerting is <strong>enabled</strong> for this canary
                    </div>
                    
                    {% if canary.interval_minutes > 43200 %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Long-Interval Job Detected:</strong> This canary has a check-in interval of {{ canary.interval_minutes // 1440 }} days. 
                        Smart alerting is now supported for jobs up to one year with extended learning periods. 
                        Select an appropriate learning period above that provides sufficient historical data for pattern analysis.
                        <a href="{{ url_for('help_smart_alerts') }}" class="alert-link" target="_blank">Learn more</a>
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Sensitivity:</strong></td>
                                    <td>{{ (smart_alert.sensitivity * 100) | round(1) }}%</td>
                                </tr>
                                <tr>
                                    <td><strong>Learning Period:</strong></td>
                                    <td>{{ smart_alert.learning_period_days }} days</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Analysis:</strong></td>
                                    <td>
                                        {% if smart_alert.last_analysis %}
                                            {{ (smart_alert.last_analysis | user_timezone).strftime('%Y-%m-%d %H:%M %Z') }}
                                        {% else %}
                                            Not analyzed yet
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Patterns Learned:</strong></td>
                                    <td>
                                        {% if smart_alert.pattern_data and smart_alert.pattern_data.total_checkins %}
                                            {{ smart_alert.pattern_data.total_checkins }} check-ins analyzed
                                        {% else %}
                                            No patterns learned yet
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Learning Status:</strong></td>
                                    <td>
                                        <div id="learning-status">
                                            <span class="badge bg-secondary">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <!-- Learning Progress Card -->
                            <div class="card" id="learning-progress-card">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-brain text-primary"></i> Learning Progress
                                    </h6>
                                    <div id="learning-progress-content">
                                        <div class="text-center">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2">Loading learning progress...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if smart_alert.pattern_data and smart_alert.pattern_data.avg_interval %}
                            <div class="card mt-3">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-chart-bar text-success"></i> Learned Patterns
                                        <button class="btn btn-outline-info btn-sm float-end" type="button" data-bs-toggle="collapse" data-bs-target="#patternDetails">
                                            <i class="fas fa-info-circle"></i> Details
                                        </button>
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="card-text mb-2">
                                                <small class="text-muted">
                                                    <strong>Expected Interval:</strong> {{ smart_alert.pattern_data.expected_interval }} minutes<br>
                                                    <strong>Actual Average:</strong> {{ smart_alert.pattern_data.avg_interval | round(1) }} minutes<br>
                                                    <strong>Normal Variance:</strong> Â±{{ smart_alert.pattern_data.interval_std | round(1) }} minutes
                                                </small>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="text-center" id="pattern-confidence-display">
                                                <div class="progress mb-1" style="height: 8px;">
                                                    <div class="progress-bar bg-success" role="progressbar" 
                                                         style="width: 85%" title="Pattern Confidence" id="confidence-bar">
                                                    </div>
                                                </div>
                                                <small class="text-muted" id="confidence-text">Pattern Confidence: Loading...</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="collapse mt-3" id="patternDetails">
                                        <div class="border-top pt-3">
                                            <h6><i class="fas fa-microscope text-primary"></i> How This Works</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p class="small mb-2"><strong>What We Analyze:</strong></p>
                                                    <ul class="small">
                                                        <li>Check-in timing patterns</li>
                                                        <li>Interval consistency</li>
                                                        <li>Day-of-week variations</li>
                                                        <li>Time-of-day preferences</li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="small mb-2"><strong>Alert Triggers:</strong></p>
                                                    <ul class="small">
                                                        <li>Intervals {{ (smart_alert.sensitivity * 100) | round(0) }}% longer than expected</li>
                                                        <li>Check-ins at unusual times</li>
                                                        <li>Sudden pattern changes</li>
                                                        <li>Multiple consecutive deviations</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <div class="alert alert-light mt-3">
                                                <h6><i class="fas fa-lightbulb text-warning"></i> Current Pattern Analysis</h6>
                                                <div id="pattern-insights">
                                                    <div class="text-center">
                                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <span class="ms-2">Loading pattern insights...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <form method="POST" action="{{ url_for('disable_smart_alert', canary_id=canary.canary_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to disable smart alerting?')">
                                <i class="fas fa-power-off"></i> Disable Smart Alerts
                            </button>
                        </form>
                        
                        {% if smart_alert.pattern_data %}
                        <form method="POST" action="{{ url_for('relearn_patterns', canary_id=canary.canary_id) }}" class="d-inline ms-2" id="relearn-form">
                            <button type="submit" class="btn btn-outline-primary btn-sm" id="relearn-btn"
                                    onclick="return confirmRelearn(this)">
                                <i class="fas fa-sync-alt" id="relearn-icon"></i> 
                                <span id="relearn-text">Re-learn Patterns</span>
                            </button>
                        </form>
                        
                        <form method="POST" action="{{ url_for('delete_pattern_data', canary_id=canary.canary_id) }}" class="d-inline ms-2" id="delete-pattern-form">
                            <button type="submit" class="btn btn-outline-warning btn-sm" id="delete-pattern-btn"
                                    onclick="return confirmDeletePattern(this)">
                                <i class="fas fa-trash-alt" id="delete-pattern-icon"></i> 
                                <span id="delete-pattern-text">Delete Pattern Data</span>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Smart alerting is <strong>disabled</strong> for this canary
                    </div>
                    
                    <p class="text-muted">
                        Smart alerting uses machine learning to analyze your check-in patterns and detect anomalies.
                        It can identify irregular check-in times, unusual intervals, and patterns that deviate from your normal schedule.
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- Configuration Card -->
        {% if not smart_alert or not smart_alert.is_enabled %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs"></i> Enable Smart Alerting
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('enable_smart_alert', canary_id=canary.canary_id) }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sensitivity" class="form-label">Sensitivity</label>
                                <input type="range" class="form-range" id="sensitivity" name="sensitivity" 
                                       min="0.5" max="1.0" step="0.1" 
                                       value="{{ smart_alert.sensitivity if smart_alert else '0.8' }}"
                                       oninput="updateSensitivityValue(this.value)">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Less sensitive</small>
                                    <small class="text-muted">More sensitive</small>
                                </div>
                                <div class="form-text">
                                    Current: <span id="sensitivity-value">{{ ((smart_alert.sensitivity if smart_alert else 0.8) * 100) | round(0) }}%</span>
                                    <br>Higher sensitivity detects smaller deviations from normal patterns.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="learning_period" class="form-label">Learning Period (days)</label>
                                <select class="form-select" id="learning_period" name="learning_period">
                                    {% set interval_days = (canary.interval_minutes / 1440) | round(1) %}
                                    
                                    {# Standard options for frequent jobs (< 7 days interval) #}
                                    {% if interval_days < 7 %}
                                    <option value="3" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 3 }}>3 days</option>
                                    <option value="7" {{ 'selected' if not smart_alert or smart_alert.learning_period_days == 7 }}>7 days (recommended)</option>
                                    <option value="14" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 14 }}>14 days</option>
                                    <option value="30" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 30 }}>30 days</option>
                                    {% endif %}
                                    
                                    {# Extended options for weekly to monthly jobs (7-30 days interval) #}
                                    {% if interval_days >= 7 and interval_days < 30 %}
                                    <option value="7" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 7 }}>7 days</option>
                                    <option value="14" {{ 'selected' if not smart_alert or smart_alert.learning_period_days == 14 }}>14 days (recommended)</option>
                                    <option value="30" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 30 }}>30 days</option>
                                    <option value="60" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 60 }}>60 days</option>
                                    <option value="90" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 90 }}>90 days</option>
                                    {% endif %}
                                    
                                    {# Extended options for monthly jobs (30-90 days interval) #}
                                    {% if interval_days >= 30 and interval_days < 90 %}
                                    <option value="30" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 30 }}>30 days</option>
                                    <option value="60" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 60 }}>60 days</option>
                                    <option value="90" {{ 'selected' if not smart_alert or smart_alert.learning_period_days == 90 }}>90 days (recommended)</option>
                                    <option value="120" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 120 }}>120 days</option>
                                    <option value="180" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 180 }}>180 days</option>
                                    {% endif %}
                                    
                                    {# Extended options for quarterly jobs (90-180 days interval) #}
                                    {% if interval_days >= 90 and interval_days < 180 %}
                                    <option value="90" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 90 }}>90 days</option>
                                    <option value="120" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 120 }}>120 days</option>
                                    <option value="180" {{ 'selected' if not smart_alert or smart_alert.learning_period_days == 180 }}>180 days (recommended)</option>
                                    <option value="270" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 270 }}>270 days</option>
                                    <option value="365" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 365 }}>365 days</option>
                                    {% endif %}
                                    
                                    {# Extended options for semi-annual and annual jobs (180+ days interval) #}
                                    {% if interval_days >= 180 %}
                                    <option value="180" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 180 }}>180 days</option>
                                    <option value="270" {{ 'selected' if smart_alert and smart_alert.learning_period_days == 270 }}>270 days</option>
                                    <option value="365" {{ 'selected' if not smart_alert or smart_alert.learning_period_days == 365 }}>365 days (recommended)</option>
                                    {% endif %}
                                </select>
                                <div class="form-text">
                                    How many days of check-in history to analyze for pattern learning.
                                    {% if interval_days > 30 %}
                                    <br><small class="text-info">For jobs with {{ interval_days }} day intervals, longer learning periods provide better pattern analysis.</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Note:</strong> Smart alerting requires at least 3 successful check-ins within the learning period to establish patterns.
                        If insufficient data is available, patterns will be learned as more check-ins occur.
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-brain"></i> Enable Smart Alerting
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Recent Check-ins Analysis Card -->
        {% if smart_alert and smart_alert.is_enabled %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history text-info"></i> Recent Check-ins & Pattern Analysis
                </h5>
            </div>
            <div class="card-body">
                <div id="checkin-timeline">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading recent check-ins...</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Alert Logic Explanation Card -->
        {% if smart_alert and smart_alert.is_enabled %}
        <div class="card mt-4 border-warning">
            <div class="card-header bg-warning bg-opacity-10">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle text-warning"></i> When Smart Alerts Trigger
                </h5>
            </div>
            <div class="card-body">
                <div id="alert-logic-explanation">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading alert trigger conditions...</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- How It Works Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle"></i> How Smart Alerting Works
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-chart-line text-primary"></i> Pattern Learning</h6>
                        <p class="small">Analyzes your check-in history to understand normal patterns by time of day, day of week, and intervals.</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-search text-warning"></i> Anomaly Detection</h6>
                        <p class="small">Compares current behavior against learned patterns to identify unusual deviations that may indicate issues.</p>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-bell text-danger"></i> Smart Notifications</h6>
                        <p class="small">Sends alerts when patterns deviate significantly from normal, reducing false positives from expected variations.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Chat Interface (only show if user has API key) -->
        {% if current_user.anthropic_api_key %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot text-primary"></i> AI Assistant
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">
                        <i class="fas fa-key"></i> Ask questions about your canary's health, patterns, or monitoring setup
                    </small>
                </div>
                
                <div id="ai-chat-messages" class="border rounded p-3 mb-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                    <div class="text-muted text-center">
                        <i class="fas fa-comment"></i> Start a conversation with your AI assistant
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" 
                           id="ai-chat-input" 
                           class="form-control" 
                           placeholder="Ask about your canary... (e.g., 'Why haven't I received any alerts?')"
                           maxlength="200">
                    <button class="btn btn-primary" type="button" id="ai-chat-send">
                        <i class="fas fa-paper-plane"></i> Ask
                    </button>
                </div>
                
                <div id="ai-chat-loading" class="text-center mt-2" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Thinking...</span>
                    </div>
                    <span class="ms-2 small">AI is analyzing...</span>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card mt-4">
            <div class="card-body text-center">
                <h6><i class="fas fa-robot text-muted"></i> AI Assistant Available</h6>
                <p class="text-muted mb-3">Add your Anthropic API key in Settings to unlock AI-powered insights and chat with your monitoring data.</p>
                <a href="{{ url_for('settings') }}" class="btn btn-outline-primary">
                    <i class="fas fa-cog"></i> Add API Key in Settings
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function updateSensitivityValue(value) {
    document.getElementById('sensitivity-value').textContent = Math.round(value * 100) + '%';
}

// Function to load pattern insights
async function loadPatternInsights() {
    try {
        const response = await fetch(`/smart_alert_insights/{{ canary.canary_id }}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch pattern insights');
        }
        
        const insights = await response.json();
        
        let insightsHtml = '<div class="row">';
        
        if (insights.timing_patterns && insights.timing_patterns.length > 0) {
            insightsHtml += '<div class="col-md-6"><h6 class="small"><i class="fas fa-clock text-primary"></i> Timing Patterns</h6><ul class="small mb-3">';
            insights.timing_patterns.forEach(pattern => {
                insightsHtml += `<li>${pattern}</li>`;
            });
            insightsHtml += '</ul></div>';
        }
        
        if (insights.anomaly_indicators && insights.anomaly_indicators.length > 0) {
            insightsHtml += '<div class="col-md-6"><h6 class="small"><i class="fas fa-exclamation-triangle text-warning"></i> Recent Anomalies</h6><ul class="small mb-3">';
            insights.anomaly_indicators.forEach(anomaly => {
                insightsHtml += `<li class="text-warning">${anomaly}</li>`;
            });
            insightsHtml += '</ul></div>';
        }
        
        insightsHtml += '</div>';
        
        if (insights.next_expected && insights.confidence > 70) {
            insightsHtml += `<div class="alert alert-info small mt-2">
                <i class="fas fa-clock"></i> <strong>Next Expected Check-in:</strong> ${insights.next_expected}
                (Confidence: ${insights.confidence}%)
            </div>`;
        }
        
        const patternInsightsElement = document.getElementById('pattern-insights');
        if (patternInsightsElement) {
            patternInsightsElement.innerHTML = insightsHtml;
        }
        
        // Update pattern confidence display
        const confidenceBar = document.getElementById('confidence-bar');
        const confidenceText = document.getElementById('confidence-text');
        
        if (confidenceBar && confidenceText) {
            if (insights.confidence !== null && insights.confidence !== undefined) {
                // Valid confidence value available
                confidenceBar.style.width = insights.confidence + '%';
                confidenceText.textContent = `Pattern Confidence: ${insights.confidence}%`;
                
                // Update bar color based on confidence level
                confidenceBar.className = 'progress-bar ' + 
                    (insights.confidence > 80 ? 'bg-success' : 
                     insights.confidence > 60 ? 'bg-warning' : 'bg-danger');
            } else {
                // No confidence data available - show insufficient data message
                confidenceBar.style.width = '0%';
                confidenceBar.className = 'progress-bar bg-secondary';
                confidenceText.textContent = 'Pattern Confidence: Insufficient data (need 3+ check-ins)';
            }
        }
        
    } catch (error) {
        console.error('Error loading pattern insights:', error);
        const patternInsightsElement = document.getElementById('pattern-insights');
        if (patternInsightsElement) {
            patternInsightsElement.innerHTML = '<p class="text-muted small mb-0">Pattern insights unavailable</p>';
        }
    }
}

// Function to load check-in timeline
async function loadCheckinTimeline() {
    try {
        const response = await fetch(`/smart_alert_timeline/{{ canary.canary_id }}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch check-in timeline');
        }
        
        const timeline = await response.json();
        
        let timelineHtml = '';
        
        if (timeline.checkins && timeline.checkins.length > 0) {
            timelineHtml += '<div class="table-responsive"><table class="table table-sm"><thead><tr>';
            timelineHtml += '<th>Time</th><th>Interval</th><th>Pattern Match</th><th>Analysis</th></tr></thead><tbody>';
            
            timeline.checkins.forEach((checkin, index) => {
                const statusClass = checkin.anomaly_score > 0.7 ? 'table-warning' : 
                                  checkin.anomaly_score > 0.4 ? 'table-info' : 'table-light';
                
                timelineHtml += `<tr class="${statusClass}">`;
                timelineHtml += `<td><small>${checkin.timestamp}</small></td>`;
                timelineHtml += `<td><small>${checkin.interval || 'N/A'}</small></td>`;
                timelineHtml += `<td><small>`;
                
                if (checkin.pattern_match > 80) {
                    timelineHtml += `<span class="badge bg-success">${checkin.pattern_match}%</span>`;
                } else if (checkin.pattern_match > 60) {
                    timelineHtml += `<span class="badge bg-warning">${checkin.pattern_match}%</span>`;
                } else {
                    timelineHtml += `<span class="badge bg-danger">${checkin.pattern_match}%</span>`;
                }
                
                timelineHtml += `</small></td>`;
                timelineHtml += `<td><small class="text-muted">${checkin.analysis || 'Normal'}</small></td>`;
                timelineHtml += '</tr>';
            });
            
            timelineHtml += '</tbody></table></div>';
            
            if (timeline.summary) {
                timelineHtml += `<div class="alert alert-light mt-3">
                    <h6><i class="fas fa-chart-line text-primary"></i> Timeline Summary</h6>
                    <p class="small mb-0">${timeline.summary}</p>
                </div>`;
            }
            
            // Add AI insights if available
            if (timeline.ai_insight) {
                timelineHtml += `<div class="alert alert-info mt-3">
                    <h6><i class="fas fa-robot text-primary"></i> AI Insight</h6>
                    <p class="small mb-0">${timeline.ai_insight}</p>
                    <small class="text-muted d-block mt-1">
                        <i class="fas fa-key"></i> Powered by your Anthropic API key
                    </small>
                </div>`;
            }
        } else {
            timelineHtml = '<p class="text-muted">No recent check-ins available for analysis.</p>';
        }
        
        const timelineElement = document.getElementById('checkin-timeline');
        if (timelineElement) {
            timelineElement.innerHTML = timelineHtml;
        }
        
    } catch (error) {
        console.error('Error loading check-in timeline:', error);
        const timelineElement = document.getElementById('checkin-timeline');
        if (timelineElement) {
            timelineElement.innerHTML = '<p class="text-danger">Error loading check-in timeline</p>';
        }
    }
}

// Function to load alert logic explanation
async function loadAlertLogicExplanation() {
    try {
        const response = await fetch(`/smart_alert_logic/{{ canary.canary_id }}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch alert logic');
        }
        
        const logic = await response.json();
        
        let explanationHtml = '<div class="row">';
        
        if (logic.current_thresholds) {
            explanationHtml += '<div class="col-md-6">';
            explanationHtml += '<h6 class="text-warning mb-3"><i class="fas fa-calculator"></i> Current Alert Thresholds</h6>';
            explanationHtml += '<div class="alert alert-light border-warning">';
            
            logic.current_thresholds.forEach(threshold => {
                explanationHtml += `<div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <span class="small">${threshold.condition}</span>
                    <strong class="text-warning">${threshold.value}</strong>
                </div>`;
            });
            
            explanationHtml += '</div></div>';
        }
        
        if (logic.recent_evaluations) {
            explanationHtml += '<div class="col-md-6">';
            explanationHtml += '<h6 class="text-info mb-3"><i class="fas fa-history"></i> Recent Evaluations</h6>';
            
            logic.recent_evaluations.forEach(eval => {
                const alertClass = eval.would_trigger ? 'alert-danger' : 'alert-success';
                const icon = eval.would_trigger ? 'fas fa-exclamation-triangle text-danger' : 'fas fa-check text-success';
                
                explanationHtml += `<div class="alert ${alertClass} p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <small><i class="${icon}"></i> ${eval.timestamp}</small>
                        <small>${eval.result}</small>
                    </div>
                    <small class="text-muted">${eval.reason}</small>
                </div>`;
            });
            
            explanationHtml += '</div>';
        }
        
        explanationHtml += '</div>';
        
        if (logic.explanation) {
            explanationHtml += `<div class="alert alert-info mt-3">
                <h6><i class="fas fa-info-circle"></i> How This Works</h6>
                <p class="mb-0 small">${logic.explanation}</p>
            </div>`;
        }
        
        // Add AI explanation if available
        if (logic.ai_explanation) {
            explanationHtml += `<div class="alert alert-primary mt-3">
                <h6><i class="fas fa-robot text-primary"></i> AI Analysis</h6>
                <p class="mb-1 small">${logic.ai_explanation}</p>
                <small class="text-muted">
                    <i class="fas fa-key"></i> Powered by your Anthropic API key
                </small>
            </div>`;
        }
        
        document.getElementById('alert-logic-explanation').innerHTML = explanationHtml;
        
    } catch (error) {
        console.error('Error loading alert logic:', error);
        document.getElementById('alert-logic-explanation').innerHTML = 
            '<p class="text-muted">Alert logic explanation unavailable</p>';
    }
}

// Function to update learning progress
async function updateLearningProgress() {
    try {
        const response = await fetch(`/smart_alert_progress/{{ canary.canary_id }}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch learning progress');
        }
        
        const progress = await response.json();
        
        // Update learning status badge
        const statusElement = document.getElementById('learning-status');
        let statusBadge = '';
        let progressHtml = '';
        
        switch(progress.status) {
            case 'ready':
                statusBadge = `<span class="badge bg-success"><i class="fas fa-check"></i> Ready</span>`;
                break;
            case 'learning':
                statusBadge = `<span class="badge bg-warning"><i class="fas fa-cog fa-spin"></i> Learning</span>`;
                break;
            case 'waiting':
                statusBadge = `<span class="badge bg-info"><i class="fas fa-clock"></i> Waiting</span>`;
                break;
            case 'error':
                statusBadge = `<span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Error</span>`;
                break;
        }
        
        statusElement.innerHTML = statusBadge;
        
        // Update progress card content
        if (progress.status !== 'error') {
            progressHtml = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Data Collection Progress</small>
                        <small class="text-muted">${progress.progress}%</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar ${progress.status === 'ready' ? 'bg-success' : 'bg-primary'}" 
                             role="progressbar" 
                             style="width: ${progress.progress}%"
                             aria-valuenow="${progress.progress}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>
                <p class="small mb-2">${progress.message}</p>`;
                
            if (progress.confidence > 0) {
                progressHtml += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Pattern Confidence</small>
                            <small class="text-muted">${progress.confidence}%</small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-info" 
                                 role="progressbar" 
                                 style="width: ${progress.confidence}%"
                                 aria-valuenow="${progress.confidence}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>`;
            }
            
            if (progress.last_updated) {
                const lastUpdated = new Date(progress.last_updated).toLocaleString();
                progressHtml += `<small class="text-muted">Last updated: ${lastUpdated}</small>`;
            }
        } else {
            progressHtml = `<p class="text-danger small mb-0">${progress.message}</p>`;
        }
        
        document.getElementById('learning-progress-content').innerHTML = progressHtml;
        
    } catch (error) {
        console.error('Error updating learning progress:', error);
        document.getElementById('learning-progress-content').innerHTML = 
            '<p class="text-danger small mb-0">Error loading progress</p>';
    }
}

// AI Chat functionality
{% if current_user.anthropic_api_key %}
function addChatMessage(message, isUser = false) {
    const messagesDiv = document.getElementById('ai-chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-2 ${isUser ? 'text-end' : ''}`;
    
    const badge = isUser ? 
        '<span class="badge bg-primary me-2"><i class="fas fa-user"></i> You</span>' :
        '<span class="badge bg-secondary me-2"><i class="fas fa-robot"></i> AI</span>';
    
    messageDiv.innerHTML = `
        ${isUser ? '' : badge}
        <span class="small ${isUser ? 'bg-primary text-white' : 'bg-light'} rounded p-2 d-inline-block" style="max-width: 80%;">
            ${message}
        </span>
        ${isUser ? badge : ''}
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

async function sendAIMessage() {
    const input = document.getElementById('ai-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addChatMessage(message, true);
    input.value = '';
    
    // Show loading
    document.getElementById('ai-chat-loading').style.display = 'block';
    
    try {
        const response = await fetch(`/ai_chat/{{ canary.canary_id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        if (data.response) {
            addChatMessage(data.response);
        } else {
            addChatMessage(data.error || 'Sorry, I encountered an error processing your request.');
        }
    } catch (error) {
        console.error('AI chat error:', error);
        addChatMessage('Sorry, I\'m temporarily unavailable. Please try again later.');
    } finally {
        document.getElementById('ai-chat-loading').style.display = 'none';
    }
}

// Set up AI chat event listeners
document.getElementById('ai-chat-send').addEventListener('click', sendAIMessage);
document.getElementById('ai-chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendAIMessage();
    }
});
{% endif %}

// Update progress immediately and then every 10 seconds for real-time feedback
{% if smart_alert and smart_alert.is_enabled %}
document.addEventListener('DOMContentLoaded', function() {
    updateLearningProgress();
    loadPatternInsights();
    loadCheckinTimeline();
    loadAlertLogicExplanation();
    
    // Update all data for real-time feedback
    setInterval(updateLearningProgress, 10000);
    setInterval(loadPatternInsights, 15000); // Pattern insights every 15 seconds
    setInterval(loadCheckinTimeline, 30000); // Timeline every 30 seconds
    setInterval(loadAlertLogicExplanation, 45000); // Alert logic every 45 seconds
});
{% endif %}

// Function to handle re-learn patterns button with visual feedback
function confirmRelearn(button) {
    if (confirm('Are you sure you want to re-learn patterns? This will analyze recent check-ins and update the ML model.')) {
        // Show loading state
        const icon = document.getElementById('relearn-icon');
        const text = document.getElementById('relearn-text');
        const btn = document.getElementById('relearn-btn');
        
        if (icon && text && btn) {
            btn.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';
            text.textContent = 'Re-learning...';
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
        }
        
        return true; // Allow form submission
    }
    return false; // Prevent form submission
}

// Function to handle delete pattern data button with visual feedback
function confirmDeletePattern(button) {
    console.log('Delete pattern button clicked');
    
    if (confirm('Are you sure you want to delete all pattern data? This will clear learned patterns but keep smart alerts enabled. New patterns will be learned from future check-ins.')) {
        console.log('User confirmed deletion');
        
        try {
            // Show loading state immediately with optimized DOM updates
            const icon = document.getElementById('delete-pattern-icon');
            const text = document.getElementById('delete-pattern-text');
            const btn = document.getElementById('delete-pattern-btn');
            
            if (icon && text && btn) {
                // Use requestAnimationFrame for smooth DOM updates
                requestAnimationFrame(() => {
                    btn.disabled = true;
                    btn.className = 'btn btn-warning btn-sm'; // Replace all classes at once
                    icon.className = 'fas fa-spinner fa-spin';
                    text.textContent = 'Deleting...';
                    console.log('Visual state updated');
                });
            } else {
                console.error('Could not find delete button elements');
            }
        } catch (e) {
            console.error('Error updating delete button state:', e);
        }
        
        console.log('Allowing form submission');
        return true; // Allow form submission
    } else {
        console.log('User cancelled deletion');
        return false; // Prevent form submission
    }
}
</script>
{% endblock %}